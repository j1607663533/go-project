# Token ç»Ÿä¸€ä»è¯·æ±‚å¤´è·å– - æ›´æ–°è¯´æ˜

## ğŸ“ æ›´æ–°å†…å®¹

å·²å°†é€€å‡ºç™»å½•åŠŸèƒ½ä¿®æ”¹ä¸ºä» **Authorization è¯·æ±‚å¤´** ä¸­è·å– tokenï¼Œè€Œä¸æ˜¯ä»è¯·æ±‚ä½“ä¸­è·å–ã€‚è¿™æ ·æ›´ç¬¦åˆ RESTful API çš„æœ€ä½³å®è·µã€‚

## ğŸ”„ ä¿®æ”¹å¯¹æ¯”

### ä¹‹å‰çš„å®ç°ï¼ˆä»è¯·æ±‚ä½“è·å–ï¼‰

```javascript
// å‰ç«¯
POST /api/v1/logout
Headers: {
  "Content-Type": "application/json"
}
Body: {
  "token": "your-jwt-token"
}

// åç«¯
func (ctrl *UserController) ExitLogin(c *gin.Context) {
    var req models.ExitLoginRequest
    c.ShouldBindJSON(&req)
    token := req.Token
    // ...
}
```

### ç°åœ¨çš„å®ç°ï¼ˆä»è¯·æ±‚å¤´è·å–ï¼‰âœ…

```javascript
// å‰ç«¯
POST /api/v1/logout
Headers: {
  "Authorization": "Bearer your-jwt-token"
}
Body: (ç©º)

// åç«¯
func (ctrl *UserController) ExitLogin(c *gin.Context) {
    authHeader := c.GetHeader("Authorization")
    parts := strings.SplitN(authHeader, " ", 2)
    token := parts[1]
    // ...
}
```

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

### 1. åç«¯æ–‡ä»¶

#### `backend/controllers/user_controller.go`

```go
// ExitLogin é€€å‡ºç™»å½•
func (ctrl *UserController) ExitLogin(c *gin.Context) {
	// ä»è¯·æ±‚å¤´è·å– token
	authHeader := c.GetHeader("Authorization")
	if authHeader == "" {
		c.JSON(http.StatusUnauthorized, gin.H{
			"code":    401,
			"message": "æœªæä¾›è®¤è¯ä»¤ç‰Œ",
		})
		return
	}

	// éªŒè¯ token æ ¼å¼ (Bearer token)
	parts := strings.SplitN(authHeader, " ", 2)
	if !(len(parts) == 2 && parts[0] == "Bearer") {
		c.JSON(http.StatusUnauthorized, gin.H{
			"code":    401,
			"message": "è®¤è¯ä»¤ç‰Œæ ¼å¼é”™è¯¯",
		})
		return
	}

	token := parts[1]

	// è°ƒç”¨æœåŠ¡å±‚é€€å‡ºç™»å½•
	err := ctrl.userService.ExitLogin(token)
	if err != nil {
		c.JSON(http.StatusInternalServerError, gin.H{
			"code":    500,
			"message": "é€€å‡ºç™»å½•å¤±è´¥",
			"error":   err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"code":    0,
		"message": "é€€å‡ºç™»å½•æˆåŠŸ",
	})
}
```

**å˜æ›´è¯´æ˜**:

- âœ… ä» `c.GetHeader("Authorization")` è·å– token
- âœ… éªŒè¯ Authorization header æ ¼å¼ï¼ˆå¿…é¡»æ˜¯ `Bearer <token>`ï¼‰
- âœ… æå– token å¹¶ä¼ é€’ç»™æœåŠ¡å±‚
- âœ… æ·»åŠ äº† `strings` åŒ…å¯¼å…¥

#### `backend/models/user.go`

```go
// åˆ é™¤äº† ExitLoginRequest ç»“æ„ä½“ï¼ˆä¸å†éœ€è¦ï¼‰
```

**å˜æ›´è¯´æ˜**:

- âŒ åˆ é™¤äº† `ExitLoginRequest` ç»“æ„ä½“
- âœ… ä¸å†éœ€è¦ä»è¯·æ±‚ä½“ç»‘å®šæ•°æ®

### 2. å‰ç«¯æ–‡ä»¶

#### `src/api/auth.js`

```javascript
// é€€å‡ºç™»å½•
export const logout = async () => {
  const token = localStorage.getItem("token");

  if (token) {
    try {
      // è°ƒç”¨åç«¯é€€å‡ºç™»å½•æ¥å£ï¼Œå°† token åŠ å…¥é»‘åå•
      // Token é€šè¿‡ Authorization header å‘é€
      const response = await fetch(`${API_BASE_URL}/logout`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });

      const data = await response.json();

      if (data.code !== 0) {
        console.warn("é€€å‡ºç™»å½• API è°ƒç”¨å¤±è´¥:", data.message);
      }
    } catch (error) {
      console.error("é€€å‡ºç™»å½•è¯·æ±‚å¤±è´¥:", error);
    }
  }

  // æ¸…é™¤æœ¬åœ°å­˜å‚¨
  localStorage.removeItem("token");
  localStorage.removeItem("user");
};
```

**å˜æ›´è¯´æ˜**:

- âœ… å°† token æ”¾åœ¨ `Authorization` header ä¸­
- âœ… ä½¿ç”¨ `Bearer ${token}` æ ¼å¼
- âŒ ç§»é™¤äº† `Content-Type: application/json` header
- âŒ ç§»é™¤äº† request body

## âœ¨ ä¼˜åŠ¿

### 1. **ç¬¦åˆ RESTful è§„èŒƒ**

- Authorization header æ˜¯ä¼ é€’è®¤è¯ä¿¡æ¯çš„æ ‡å‡†æ–¹å¼
- ä¸å…¶ä»–éœ€è¦è®¤è¯çš„æ¥å£ä¿æŒä¸€è‡´

### 2. **ä»£ç ä¸€è‡´æ€§**

- ä¸ `getProfile` ç­‰å…¶ä»–è®¤è¯æ¥å£ä½¿ç”¨ç›¸åŒçš„æ–¹å¼ä¼ é€’ token
- ç»Ÿä¸€çš„è®¤è¯æ¨¡å¼ï¼Œæ˜“äºç»´æŠ¤

### 3. **å®‰å…¨æ€§**

- Authorization header ä¸ä¼šè¢«è®°å½•åœ¨æŸäº›æ—¥å¿—ç³»ç»Ÿä¸­
- é¿å… token å‡ºç°åœ¨ request body çš„æ—¥å¿—ä¸­

### 4. **ç®€åŒ–ä»£ç **

- åç«¯ä¸éœ€è¦å®šä¹‰é¢å¤–çš„è¯·æ±‚æ¨¡å‹ï¼ˆ`ExitLoginRequest`ï¼‰
- å¯ä»¥å¤ç”¨ç°æœ‰çš„ token è§£æé€»è¾‘

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### ä½¿ç”¨æµè§ˆå™¨æµ‹è¯•

1. æ‰“å¼€ `http://localhost:5173`
2. ç™»å½•ç³»ç»Ÿ
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network æ ‡ç­¾
4. ç‚¹å‡» "é€€å‡ºç™»å½•" æŒ‰é’®
5. æŸ¥çœ‹ `/logout` è¯·æ±‚ï¼š
   - **Request Headers** åº”åŒ…å«: `Authorization: Bearer <token>`
   - **Request Body** åº”è¯¥ä¸ºç©º
   - **Response** åº”è¯¥æ˜¯: `{"code":0,"message":"é€€å‡ºç™»å½•æˆåŠŸ"}`

### ä½¿ç”¨ curl æµ‹è¯•

```bash
# å…ˆç™»å½•è·å– token
curl -X POST http://localhost:8080/api/v1/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "your-username",
    "password": "your-password",
    "captcha_id": "captcha-id",
    "captcha": "123456"
  }'

# ä½¿ç”¨è·å–çš„ token é€€å‡ºç™»å½•
curl -X POST http://localhost:8080/api/v1/logout \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### ä½¿ç”¨ Postman æµ‹è¯•

1. **è¯·æ±‚ç±»å‹**: POST
2. **URL**: `http://localhost:8080/api/v1/logout`
3. **Headers**:
   - Key: `Authorization`
   - Value: `Bearer your-token-here`
4. **Body**: é€‰æ‹© "none"ï¼ˆä¸éœ€è¦ bodyï¼‰

## ğŸ“Š è¯·æ±‚æµç¨‹

```
å‰ç«¯ç‚¹å‡»é€€å‡ºç™»å½•
    â†“
ä» localStorage è·å– token
    â†“
å‘é€ POST /api/v1/logout
Headers: { Authorization: "Bearer <token>" }
    â†“
åç«¯ä» Authorization header æå– token
    â†“
éªŒè¯ token æ ¼å¼ (Bearer <token>)
    â†“
è§£æå¹¶éªŒè¯ token æœ‰æ•ˆæ€§
    â†“
å°† token åŠ å…¥ Redis é»‘åå•
    â†“
è¿”å›æˆåŠŸå“åº”
    â†“
å‰ç«¯æ¸…é™¤ localStorage
    â†“
è·³è½¬åˆ°ç™»å½•é¡µé¢
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Header æ ¼å¼å¿…é¡»æ­£ç¡®**:

   - å¿…é¡»æ˜¯ `Authorization: Bearer <token>`
   - `Bearer` å’Œ token ä¹‹é—´æœ‰ä¸€ä¸ªç©ºæ ¼
   - å¤§å°å†™æ•æ„Ÿ

2. **é”™è¯¯å¤„ç†**:

   - å¦‚æœæ²¡æœ‰æä¾› Authorization header â†’ 401 "æœªæä¾›è®¤è¯ä»¤ç‰Œ"
   - å¦‚æœæ ¼å¼é”™è¯¯ï¼ˆä¸æ˜¯ Bearer tokenï¼‰â†’ 401 "è®¤è¯ä»¤ç‰Œæ ¼å¼é”™è¯¯"
   - å¦‚æœ token æ— æ•ˆ â†’ 500 "é€€å‡ºç™»å½•å¤±è´¥"

3. **å‘åå…¼å®¹**:
   - æ­¤æ›´æ”¹ä¸å‘åå…¼å®¹
   - æ—§ç‰ˆæœ¬çš„å‰ç«¯ä»£ç å°†æ— æ³•æ­£å¸¸é€€å‡ºç™»å½•
   - éœ€è¦åŒæ—¶æ›´æ–°å‰ç«¯å’Œåç«¯

## âœ… éªŒè¯æ¸…å•

- [ ] åç«¯ç¼–è¯‘æˆåŠŸï¼ˆæ— é”™è¯¯ï¼‰
- [ ] å‰ç«¯ä»£ç æ›´æ–°å®Œæˆ
- [ ] é€€å‡ºç™»å½•åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] Network è¯·æ±‚æ˜¾ç¤º token åœ¨ Authorization header ä¸­
- [ ] Request body ä¸ºç©º
- [ ] é€€å‡ºå token è¢«åŠ å…¥é»‘åå•
- [ ] æ— æ³•ä½¿ç”¨æ—§ token è®¿é—®å—ä¿æŠ¤æ¥å£

## ğŸ‰ æ€»ç»“

ç°åœ¨é€€å‡ºç™»å½•æ¥å£å·²ç»å®Œå…¨ç¬¦åˆ RESTful API çš„æœ€ä½³å®è·µï¼š

- âœ… Token ä» Authorization header è·å–
- âœ… ä½¿ç”¨æ ‡å‡†çš„ Bearer token æ ¼å¼
- âœ… ä¸å…¶ä»–è®¤è¯æ¥å£ä¿æŒä¸€è‡´
- âœ… ä»£ç æ›´ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
