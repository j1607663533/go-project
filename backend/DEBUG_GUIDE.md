# Go åç«¯æ–­ç‚¹è°ƒè¯•æŒ‡å—

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£… Go æ‰©å±•

ç¡®ä¿ VS Code å·²å®‰è£… Go æ‰©å±•ï¼š

- æ‰©å±•åï¼š`Go`
- å‘å¸ƒè€…ï¼š`Go Team at Google`

### 2. å®‰è£… Delve è°ƒè¯•å™¨

åœ¨ç»ˆç«¯æ‰§è¡Œï¼š

```bash
go install github.com/go-delve/delve/cmd/dlv@latest
```

## ğŸš€ å¼€å§‹è°ƒè¯•

### æ–¹æ³• 1: ä½¿ç”¨ VS Code è°ƒè¯•å™¨ï¼ˆæ¨èï¼‰

1. **åœæ­¢å½“å‰è¿è¡Œçš„åç«¯**

   - åœ¨ç»ˆç«¯æŒ‰ `Ctrl+C` åœæ­¢ `go run main.go`

2. **æ‰“å¼€è¦è°ƒè¯•çš„æ–‡ä»¶**

   - ä¾‹å¦‚ï¼š`backend/services/user_service.go`

3. **è®¾ç½®æ–­ç‚¹**

   - åœ¨ä»£ç è¡Œå·å·¦ä¾§ç‚¹å‡»ï¼Œå‡ºç°çº¢ç‚¹å³ä¸ºæ–­ç‚¹
   - å¸¸ç”¨æ–­ç‚¹ä½ç½®ï¼š
     - `Login` æ–¹æ³•å¼€å§‹å¤„
     - è·å–èœå•çš„åœ°æ–¹
     - æ„å»ºèœå•æ ‘çš„åœ°æ–¹

4. **å¯åŠ¨è°ƒè¯•**

   - æŒ‰ `F5` æˆ–ç‚¹å‡»å·¦ä¾§è°ƒè¯•å›¾æ ‡
   - é€‰æ‹© "Launch Backend"
   - ç­‰å¾…è°ƒè¯•å™¨å¯åŠ¨ï¼ˆä¼šçœ‹åˆ° "Debugger listening" æç¤ºï¼‰

5. **è§¦å‘æ–­ç‚¹**

   - åœ¨å‰ç«¯æ‰§è¡Œç™»å½•æ“ä½œ
   - ä»£ç ä¼šåœ¨æ–­ç‚¹å¤„æš‚åœ

6. **è°ƒè¯•æ“ä½œ**
   - `F10`: å•æ­¥è·³è¿‡ï¼ˆStep Overï¼‰
   - `F11`: å•æ­¥è¿›å…¥ï¼ˆStep Intoï¼‰
   - `Shift+F11`: å•æ­¥è·³å‡ºï¼ˆStep Outï¼‰
   - `F5`: ç»§ç»­æ‰§è¡Œï¼ˆContinueï¼‰
   - é¼ æ ‡æ‚¬åœåœ¨å˜é‡ä¸ŠæŸ¥çœ‹å€¼
   - åœ¨ "å˜é‡" é¢æ¿æŸ¥çœ‹æ‰€æœ‰å˜é‡
   - åœ¨ "è°ƒè¯•æ§åˆ¶å°" æ‰§è¡Œè¡¨è¾¾å¼

### æ–¹æ³• 2: ä½¿ç”¨ Delve å‘½ä»¤è¡Œ

1. **å¯åŠ¨è°ƒè¯•æœåŠ¡å™¨**

```bash
cd backend
dlv debug --headless --listen=:2345 --api-version=2 --accept-multiclient
```

2. **åœ¨ VS Code ä¸­é™„åŠ **
   - æŒ‰ `F5`
   - é€‰æ‹© "Attach to Process"

### æ–¹æ³• 3: ä½¿ç”¨æ—¥å¿—è°ƒè¯•

å¦‚æœä¸æƒ³ç”¨æ–­ç‚¹ï¼Œå¯ä»¥æ·»åŠ æ—¥å¿—ï¼š

```go
import "log"

// åœ¨éœ€è¦è°ƒè¯•çš„åœ°æ–¹æ·»åŠ 
log.Printf("Debug: menus = %+v\n", menus)
log.Printf("Debug: user role_id = %d\n", user.RoleID)
```

## ğŸ“ å¸¸ç”¨è°ƒè¯•ç‚¹

### 1. ç™»å½•æµç¨‹

**æ–‡ä»¶**: `backend/services/user_service.go`

**å…³é”®æ–­ç‚¹**:

```go
// Line ~180: Login æ–¹æ³•å¼€å§‹
func (s *userService) Login(req *models.LoginRequest) (*models.LoginResponse, error) {
    // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œ

// Line ~200: è·å–ç”¨æˆ·èœå•
if user.RoleID > 0 {
    userMenus, err := s.menuRepo.FindByRoleID(user.RoleID)
    // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œï¼ŒæŸ¥çœ‹ userMenus

// Line ~205: æ„å»ºèœå•æ ‘
menus = s.menuRepo.BuildMenuTree(userMenus)
// è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œï¼ŒæŸ¥çœ‹ menus
```

### 2. èœå•æ ‘æ„å»º

**æ–‡ä»¶**: `backend/repositories/menu_repository.go`

**å…³é”®æ–­ç‚¹**:

```go
// Line ~70: BuildMenuTree æ–¹æ³•å¼€å§‹
func (r *menuRepository) BuildMenuTree(menus []models.Menu) []models.MenuTreeResponse {
    // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œ

// Line ~91: æ„å»ºæ ‘å½¢ç»“æ„çš„å¾ªç¯
for _, menu := range menus {
    if menu.ParentID == 0 {
        // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œï¼ŒæŸ¥çœ‹é¡¶çº§èœå•
    } else {
        // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œï¼ŒæŸ¥çœ‹å­èœå•æ·»åŠ è¿‡ç¨‹
    }
}
```

### 3. èœå•æŸ¥è¯¢

**æ–‡ä»¶**: `backend/repositories/menu_repository.go`

**å…³é”®æ–­ç‚¹**:

```go
// Line ~60: FindByRoleID æ–¹æ³•
func (r *menuRepository) FindByRoleID(roleID uint) ([]models.Menu, error) {
    // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œ
    var menus []models.Menu
    err := r.db.Table("menus").
        Joins("INNER JOIN role_menus ON menus.id = role_menus.menu_id").
        Where("role_menus.role_id = ? AND menus.status = ? AND menus.type = ?", roleID, 1, 1).
        Order("menus.sort ASC, menus.id ASC").
        Find(&menus).Error
    // è®¾ç½®æ–­ç‚¹åœ¨è¿™é‡Œï¼ŒæŸ¥çœ‹æŸ¥è¯¢ç»“æœ
    return menus, err
}
```

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å˜é‡å€¼

åœ¨æ–­ç‚¹å¤„ï¼Œå¯ä»¥ï¼š

- é¼ æ ‡æ‚¬åœåœ¨å˜é‡ä¸Š
- åœ¨ "å˜é‡" é¢æ¿æŸ¥çœ‹
- åœ¨ "è°ƒè¯•æ§åˆ¶å°" è¾“å…¥å˜é‡å

### 2. æ¡ä»¶æ–­ç‚¹

å³é”®æ–­ç‚¹ â†’ "ç¼–è¾‘æ–­ç‚¹" â†’ æ·»åŠ æ¡ä»¶

```go
// ä¾‹å¦‚ï¼šåªåœ¨ roleID == 1 æ—¶æš‚åœ
roleID == 1
```

### 3. æ—¥å¿—ç‚¹

å³é”®è¡Œå· â†’ "æ·»åŠ æ—¥å¿—ç‚¹"

- ä¸ä¼šæš‚åœæ‰§è¡Œ
- åªè¾“å‡ºæ—¥å¿—

### 4. æŸ¥çœ‹ SQL æŸ¥è¯¢

åœ¨ GORM æŸ¥è¯¢åæ·»åŠ ï¼š

```go
log.Printf("SQL: %v", r.db.ToSQL(func(tx *gorm.DB) *gorm.DB {
    return tx.Table("menus").Find(&menus)
}))
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. æ–­ç‚¹ä¸ç”Ÿæ•ˆ

**åŸå› **: ä»£ç å¯èƒ½è¢«ä¼˜åŒ–äº†

**è§£å†³**: ä½¿ç”¨ `-gcflags="all=-N -l"` ç¦ç”¨ä¼˜åŒ–

```bash
go build -gcflags="all=-N -l" -o app
dlv exec ./app
```

### 2. æ— æ³•é™„åŠ åˆ°è¿›ç¨‹

**åŸå› **: æƒé™ä¸è¶³

**è§£å†³**: ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ VS Code

### 3. è°ƒè¯•å™¨å¯åŠ¨æ…¢

**åŸå› **: éœ€è¦ç¼–è¯‘

**è§£å†³**: ç­‰å¾…ç¼–è¯‘å®Œæˆï¼Œæˆ–ä½¿ç”¨å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶

## ğŸ“ è°ƒè¯•æ£€æŸ¥æ¸…å•

è°ƒè¯•èœå•é—®é¢˜æ—¶ï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

- [ ] `user.RoleID` çš„å€¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯ 1 æˆ– 2ï¼‰
- [ ] `FindByRoleID` è¿”å›çš„ `menus` æ•°é‡
- [ ] `menus` ä¸­æ˜¯å¦åŒ…å«å­èœå•ï¼ˆparent_id != 0ï¼‰
- [ ] `BuildMenuTree` çš„è¾“å…¥å‚æ•°
- [ ] `menuMap` çš„å†…å®¹
- [ ] `roots` æ•°ç»„çš„å†…å®¹
- [ ] æœ€ç»ˆè¿”å›çš„ `result` æ˜¯å¦åŒ…å« `children`

## ğŸ¯ å¿«é€Ÿè°ƒè¯•æ­¥éª¤

1. åœ¨ `user_service.go` çš„ `Login` æ–¹æ³•ä¸­è®¾ç½®æ–­ç‚¹
2. æŒ‰ `F5` å¯åŠ¨è°ƒè¯•
3. åœ¨å‰ç«¯ç™»å½•
4. ä»£ç æš‚åœåœ¨æ–­ç‚¹å¤„
5. æŒ‰ `F10` é€æ­¥æ‰§è¡Œ
6. æŸ¥çœ‹ `userMenus` å’Œ `menus` çš„å€¼
7. ç¡®è®¤ `menus` ä¸­æ˜¯å¦æœ‰ `children`

## ğŸ’¡ æç¤º

- è°ƒè¯•æ—¶å‰ç«¯è¯·æ±‚ä¼šè¶…æ—¶ï¼Œè¿™æ˜¯æ­£å¸¸çš„
- å¯ä»¥åœ¨è°ƒè¯•æ§åˆ¶å°æ‰§è¡Œ Go è¡¨è¾¾å¼
- ä½¿ç”¨ "ç›‘è§†" é¢æ¿æ·»åŠ è¦æŒç»­è§‚å¯Ÿçš„è¡¨è¾¾å¼
- è°ƒè¯•å®Œæˆåè®°å¾—æŒ‰ `Shift+F5` åœæ­¢è°ƒè¯•å™¨

---

**å¿«æ·é”®æ€»ç»“**:

- `F5`: å¯åŠ¨/ç»§ç»­
- `F9`: åˆ‡æ¢æ–­ç‚¹
- `F10`: å•æ­¥è·³è¿‡
- `F11`: å•æ­¥è¿›å…¥
- `Shift+F11`: å•æ­¥è·³å‡º
- `Shift+F5`: åœæ­¢è°ƒè¯•
