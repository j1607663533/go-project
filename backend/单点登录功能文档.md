# å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åŠŸèƒ½å®ç°æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²æˆåŠŸå®ç°å•ç‚¹ç™»å½•ï¼ˆSingle Sign-Onï¼‰åŠŸèƒ½ï¼Œç¡®ä¿åŒä¸€ä¸ªè´¦å·åœ¨åŒä¸€æ—¶é—´åªèƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ç™»å½•ã€‚å½“ç”¨æˆ·åœ¨æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡çš„ç™»å½•ä¼šè¯ä¼šè‡ªåŠ¨å¤±æ•ˆã€‚

## ğŸ¯ å®ç°åŸç†

### æ ¸å¿ƒæœºåˆ¶

1. **Token å­˜å‚¨**: æ¯ä¸ªç”¨æˆ·çš„å½“å‰æœ‰æ•ˆ token å­˜å‚¨åœ¨ Redis ä¸­

   - Key: `user:token:{userID}`
   - Value: æœ€æ–°çš„ JWT token
   - TTL: 24 å°æ—¶ï¼ˆä¸ token æœ‰æ•ˆæœŸä¸€è‡´ï¼‰

2. **ç™»å½•æ—¶**:

   - ç”Ÿæˆæ–° token
   - å°†æ—§ token åŠ å…¥é»‘åå•
   - å­˜å‚¨æ–° token ä¸ºå½“å‰æœ‰æ•ˆ token

3. **è®¤è¯æ—¶**:
   - æ£€æŸ¥ token æ˜¯å¦åœ¨é»‘åå•ä¸­
   - æ£€æŸ¥ token æ˜¯å¦æ˜¯ç”¨æˆ·çš„å½“å‰æœ‰æ•ˆ token
   - ä¸¤ä¸ªæ£€æŸ¥éƒ½é€šè¿‡æ‰å…è®¸è®¿é—®

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `backend/utils/jwt.go`

æ–°å¢äº†ä¸‰ä¸ªå‡½æ•°æ¥æ”¯æŒå•ç‚¹ç™»å½•ï¼š

#### `SetUserToken` - è®¾ç½®ç”¨æˆ·å½“å‰ token

```go
func SetUserToken(userID uint, newToken string) error {
    userTokenKey := fmt.Sprintf("user:token:%d", userID)

    // è·å–ç”¨æˆ·çš„æ—§ token
    var oldToken string
    err := CacheGet(userTokenKey, &oldToken)
    if err == nil && oldToken != "" && oldToken != newToken {
        // å°†æ—§ token åŠ å…¥é»‘åå•
        ClearToken(oldToken)
    }

    // å­˜å‚¨æ–° tokenï¼Œè¿‡æœŸæ—¶é—´ 24 å°æ—¶
    return CacheSet(userTokenKey, newToken, 24*time.Hour)
}
```

**åŠŸèƒ½**:

- è·å–ç”¨æˆ·çš„æ—§ token
- å¦‚æœå­˜åœ¨æ—§ tokenï¼Œå°†å…¶åŠ å…¥é»‘åå•
- å­˜å‚¨æ–° token ä½œä¸ºå½“å‰æœ‰æ•ˆ token

#### `GetUserToken` - è·å–ç”¨æˆ·å½“å‰ token

```go
func GetUserToken(userID uint) (string, error) {
    userTokenKey := fmt.Sprintf("user:token:%d", userID)
    var token string
    err := CacheGet(userTokenKey, &token)
    return token, err
}
```

**åŠŸèƒ½**:

- ä» Redis è·å–ç”¨æˆ·çš„å½“å‰æœ‰æ•ˆ token

#### `IsUserCurrentToken` - æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰æœ‰æ•ˆ token

```go
func IsUserCurrentToken(userID uint, tokenString string) bool {
    currentToken, err := GetUserToken(userID)
    if err != nil {
        return false
    }
    return currentToken == tokenString
}
```

**åŠŸèƒ½**:

- éªŒè¯ç»™å®šçš„ token æ˜¯å¦æ˜¯ç”¨æˆ·çš„å½“å‰æœ‰æ•ˆ token

### 2. `backend/services/user_service.go`

åœ¨ç™»å½•æœåŠ¡ä¸­æ·»åŠ äº†å•ç‚¹ç™»å½•æ”¯æŒï¼š

```go
// Login ç”¨æˆ·ç™»å½•
func (s *userService) Login(req *models.LoginRequest) (*models.LoginResponse, error) {
    // ... éªŒè¯ç ã€ç”¨æˆ·åã€å¯†ç éªŒè¯ ...

    // ç”Ÿæˆ JWT token
    token, err := utils.GenerateToken(user.ID, user.Username, user.Email)
    if err != nil {
        return nil, errors.New("ç”Ÿæˆ token å¤±è´¥")
    }

    // å•ç‚¹ç™»å½•ï¼šè®¾ç½®ç”¨æˆ·çš„å½“å‰ tokenï¼Œæ—§ token ä¼šè¢«è‡ªåŠ¨åŠ å…¥é»‘åå•
    if err := utils.SetUserToken(user.ID, token); err != nil {
        return nil, errors.New("è®¾ç½®ç”¨æˆ· token å¤±è´¥")
    }

    // è¿”å›ç™»å½•å“åº”
    return &models.LoginResponse{
        Token: token,
        User:  user.ToResponse(),
    }, nil
}
```

**å˜æ›´è¯´æ˜**:

- âœ… åœ¨ç”Ÿæˆ token åè°ƒç”¨ `SetUserToken`
- âœ… è‡ªåŠ¨å°†æ—§ token åŠ å…¥é»‘åå•
- âœ… å­˜å‚¨æ–° token ä¸ºå½“å‰æœ‰æ•ˆ token

### 3. `backend/middlewares/auth.go`

åœ¨è®¤è¯ä¸­é—´ä»¶ä¸­æ·»åŠ äº†å•ç‚¹ç™»å½•æ£€æŸ¥ï¼š

```go
// AuthMiddleware è®¤è¯ä¸­é—´ä»¶
func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // ... è·å–å’Œè§£æ token ...

        // è§£æå¹¶éªŒè¯ JWT token
        claims, err := utils.ParseToken(token)
        if err != nil {
            c.JSON(http.StatusUnauthorized, gin.H{
                "code":    401,
                "message": "æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ",
            })
            c.Abort()
            return
        }

        // å•ç‚¹ç™»å½•æ£€æŸ¥ï¼šéªŒè¯ token æ˜¯å¦æ˜¯ç”¨æˆ·çš„å½“å‰æœ‰æ•ˆ token
        if !utils.IsUserCurrentToken(claims.UserID, token) {
            c.JSON(http.StatusUnauthorized, gin.H{
                "code":    401,
                "message": "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•",
            })
            c.Abort()
            return
        }

        // å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­
        c.Set("userID", claims.UserID)
        c.Set("username", claims.Username)
        c.Set("email", claims.Email)

        c.Next()
    }
}
```

**å˜æ›´è¯´æ˜**:

- âœ… åœ¨ token è§£æåæ·»åŠ å•ç‚¹ç™»å½•æ£€æŸ¥
- âœ… å¦‚æœä¸æ˜¯å½“å‰æœ‰æ•ˆ tokenï¼Œè¿”å› 401 é”™è¯¯
- âœ… é”™è¯¯æ¶ˆæ¯ï¼š"æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"

## ğŸ”„ å®Œæ•´æµç¨‹

### åœºæ™¯ 1: æ­£å¸¸ç™»å½•

```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½•
  â†“
ç”Ÿæˆ token_1
  â†“
å­˜å‚¨: user:token:123 = token_1
  â†“
è¿”å› token_1 ç»™ç”¨æˆ·
  â†“
ç”¨æˆ· A ä½¿ç”¨ token_1 è®¿é—® API âœ…
```

### åœºæ™¯ 2: å•ç‚¹ç™»å½•è§¦å‘

```
ç”¨æˆ· A åœ¨è®¾å¤‡ 1 ç™»å½• (token_1)
  â†“
ç”¨æˆ· A åœ¨è®¾å¤‡ 2 ç™»å½•
  â†“
ç”Ÿæˆ token_2
  â†“
å°† token_1 åŠ å…¥é»‘åå•
  â†“
å­˜å‚¨: user:token:123 = token_2
  â†“
è¿”å› token_2 ç»™ç”¨æˆ·
  â†“
è®¾å¤‡ 1 ä½¿ç”¨ token_1 è®¿é—® API âŒ
  â†’ è¿”å›: "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"
  â†“
è®¾å¤‡ 2 ä½¿ç”¨ token_2 è®¿é—® API âœ…
```

### åœºæ™¯ 3: é€€å‡ºç™»å½•

```
ç”¨æˆ· A é€€å‡ºç™»å½•
  â†“
å°† token åŠ å…¥é»‘åå•
  â†“
æ¸…é™¤æœ¬åœ°å­˜å‚¨
  â†“
ç”¨æˆ· A ä½¿ç”¨æ—§ token è®¿é—® API âŒ
  â†’ è¿”å›: "è®¤è¯ä»¤ç‰Œå·²å¤±æ•ˆ"
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: å•ç‚¹ç™»å½•éªŒè¯

1. **è®¾å¤‡ 1 ç™»å½•**:

   ```bash
   curl -X POST http://localhost:8080/api/v1/login \
     -H "Content-Type: application/json" \
     -d '{
       "username": "testuser",
       "password": "password123",
       "captcha_id": "xxx",
       "captcha": "123456"
     }'
   ```

   ä¿å­˜è¿”å›çš„ `token_1`

2. **è®¾å¤‡ 1 è®¿é—® API**:

   ```bash
   curl -X GET http://localhost:8080/api/v1/auth/profile \
     -H "Authorization: Bearer token_1"
   ```

   âœ… åº”è¯¥æˆåŠŸè¿”å›ç”¨æˆ·ä¿¡æ¯

3. **è®¾å¤‡ 2 ç™»å½•**ï¼ˆåŒä¸€ä¸ªè´¦å·ï¼‰:

   ```bash
   curl -X POST http://localhost:8080/api/v1/login \
     -H "Content-Type: application/json" \
     -d '{
       "username": "testuser",
       "password": "password123",
       "captcha_id": "yyy",
       "captcha": "654321"
     }'
   ```

   ä¿å­˜è¿”å›çš„ `token_2`

4. **è®¾å¤‡ 1 å†æ¬¡è®¿é—® API**ï¼ˆä½¿ç”¨ token_1ï¼‰:

   ```bash
   curl -X GET http://localhost:8080/api/v1/auth/profile \
     -H "Authorization: Bearer token_1"
   ```

   âŒ åº”è¯¥è¿”å›:

   ```json
   {
     "code": 401,
     "message": "æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"
   }
   ```

5. **è®¾å¤‡ 2 è®¿é—® API**ï¼ˆä½¿ç”¨ token_2ï¼‰:
   ```bash
   curl -X GET http://localhost:8080/api/v1/auth/profile \
     -H "Authorization: Bearer token_2"
   ```
   âœ… åº”è¯¥æˆåŠŸè¿”å›ç”¨æˆ·ä¿¡æ¯

### æµ‹è¯• 2: å‰ç«¯æµ‹è¯•

1. **æµè§ˆå™¨ 1**: ç™»å½•è´¦å· A
2. **æµè§ˆå™¨ 2**: ä½¿ç”¨ç›¸åŒè´¦å· A ç™»å½•
3. **æµè§ˆå™¨ 1**: åˆ·æ–°é¡µé¢æˆ–è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢
4. **é¢„æœŸç»“æœ**: æµè§ˆå™¨ 1 ä¼šæ”¶åˆ° 401 é”™è¯¯ï¼Œæç¤º"æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"

## ğŸ“Š Redis æ•°æ®ç»“æ„

### Token é»‘åå•

```
Key: blacklist:token:{token_string}
Value: true
TTL: token å‰©ä½™æœ‰æ•ˆæ—¶é—´
```

### ç”¨æˆ·å½“å‰ Token

```
Key: user:token:{userID}
Value: current_token_string
TTL: 24 å°æ—¶
```

### ç¤ºä¾‹

```
# ç”¨æˆ· ID ä¸º 123 çš„å½“å‰ token
user:token:123 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# è¢«åŠ å…¥é»‘åå•çš„æ—§ token
blacklist:token:eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... = true
```

## âœ¨ åŠŸèƒ½ç‰¹ç‚¹

### 1. **è‡ªåŠ¨å¤±æ•ˆ**

- âœ… æ–°ç™»å½•è‡ªåŠ¨ä½¿æ—§ token å¤±æ•ˆ
- âœ… æ— éœ€æ‰‹åŠ¨ç®¡ç† token é»‘åå•
- âœ… Redis TTL è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

### 2. **å®‰å…¨æ€§**

- âœ… é˜²æ­¢è´¦å·å…±äº«
- âœ… é˜²æ­¢ token æ³„éœ²åçš„æŒç»­ä½¿ç”¨
- âœ… ç¡®ä¿ç”¨æˆ·è´¦å·å®‰å…¨

### 3. **ç”¨æˆ·ä½“éªŒ**

- âœ… æ˜ç¡®çš„é”™è¯¯æç¤ºï¼š"æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"
- âœ… è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
- âœ… æ”¯æŒå¤šæ¬¡ç™»å½•ï¼ˆæœ€æ–°çš„æœ‰æ•ˆï¼‰

### 4. **æ€§èƒ½ä¼˜åŒ–**

- âœ… ä½¿ç”¨ Redis ç¼“å­˜ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«
- âœ… TTL è‡ªåŠ¨è¿‡æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
- âœ… æœ€å°åŒ–æ•°æ®åº“æŸ¥è¯¢

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Redis ä¾èµ–

- å•ç‚¹ç™»å½•åŠŸèƒ½ä¾èµ– Redis
- å¦‚æœ Redis ä¸å¯ç”¨ï¼Œä¼šé™çº§åˆ°åŸºæœ¬çš„ token éªŒè¯
- å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒé…ç½® Redis é«˜å¯ç”¨

### 2. Token æœ‰æ•ˆæœŸ

- å½“å‰è®¾ç½®ä¸º 24 å°æ—¶
- å¯ä»¥åœ¨ `jwt.go` ä¸­çš„ `GenerateToken` å‡½æ•°ä¸­ä¿®æ”¹
- ä¿®æ”¹åéœ€è¦åŒæ­¥æ›´æ–° `SetUserToken` ä¸­çš„ TTL

### 3. å¤šè®¾å¤‡åœºæ™¯

- å½“å‰å®ç°æ˜¯ä¸¥æ ¼çš„å•ç‚¹ç™»å½•ï¼ˆåªå…è®¸ä¸€ä¸ªè®¾å¤‡ï¼‰
- å¦‚æœéœ€è¦æ”¯æŒå¤šè®¾å¤‡ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºå­˜å‚¨ token åˆ—è¡¨
- æˆ–è€…æ·»åŠ è®¾å¤‡ç®¡ç†åŠŸèƒ½

### 4. é€€å‡ºç™»å½•

- é€€å‡ºç™»å½•ä¼šå°† token åŠ å…¥é»‘åå•
- ä½†ä¸ä¼šæ¸…é™¤ Redis ä¸­çš„ `user:token:{userID}`
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºä¸‹æ¬¡ç™»å½•ä¼šè¦†ç›–

## ğŸ‰ æ€»ç»“

å•ç‚¹ç™»å½•åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. âœ… **å®‰å…¨æ€§é«˜** - é˜²æ­¢è´¦å·å…±äº«å’Œ token æ³„éœ²
2. âœ… **è‡ªåŠ¨åŒ–** - æ— éœ€æ‰‹åŠ¨ç®¡ç†ï¼Œè‡ªåŠ¨å¤„ç†æ—§ token
3. âœ… **ç”¨æˆ·å‹å¥½** - æ¸…æ™°çš„é”™è¯¯æç¤º
4. âœ… **æ€§èƒ½ä¼˜ç§€** - åŸºäº Redisï¼Œå“åº”å¿«é€Ÿ
5. âœ… **æ˜“äºç»´æŠ¤** - ä»£ç ç»“æ„æ¸…æ™°ï¼Œé€»è¾‘ç®€å•

ç°åœ¨ä½ çš„ç³»ç»Ÿå·²ç»æ”¯æŒå®Œæ•´çš„å•ç‚¹ç™»å½•åŠŸèƒ½ï¼ğŸŠ
